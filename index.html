<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medici√≥n de Desnivel con RTK Profesional</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .mode-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }

        .mode-btn {
            padding: 15px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .rtk-config {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .rtk-config.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        .rtk-config h3 {
            color: #2a5298;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rtk-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .rtk-status-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }

        .rtk-status-item.connected {
            border-left-color: #28a745;
        }

        .rtk-status-item.fix {
            border-left-color: #17a2b8;
        }

        .rtk-status-item.float {
            border-left-color: #ffc107;
        }

        .rtk-status-item.error {
            border-left-color: #dc3545;
        }

        .rtk-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .rtk-value {
            font-size: 18px;
            font-weight: bold;
            color: #2a5298;
        }

        .step {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .step-title {
            font-size: 18px;
            font-weight: bold;
            color: #2a5298;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
        }

        .input-field label {
            font-size: 13px;
            color: #555;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .input-field input, .input-field select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-field input:focus, .input-field select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-field input:disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-rtk {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .gps-status {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #e0e0e0;
        }

        .gps-status.active {
            border-color: #28a745;
            background: #f0fff4;
        }

        .gps-status.rtk-fix {
            border-color: #17a2b8;
            background: #e7f9fc;
        }

        .gps-status.rtk-float {
            border-color: #ffc107;
            background: #fff8e1;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-dot.active {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-dot.rtk-fix {
            background: #17a2b8;
            animation: pulse 1s infinite;
        }

        .status-dot.rtk-float {
            background: #ffc107;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .results {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            display: none;
        }

        .results.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results h3 {
            color: #2a5298;
            margin-bottom: 20px;
            font-size: 22px;
            text-align: center;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .result-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .result-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .result-value {
            font-size: 24px;
            color: #2a5298;
            font-weight: bold;
        }

        .result-unit {
            font-size: 14px;
            color: #888;
            margin-left: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .point-saved {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .point-saved.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        .accuracy-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-top: 10px;
        }

        .accuracy-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .accuracy-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
            transition: width 0.3s;
        }

        @media (max-width: 768px) {
            .mode-selector {
                grid-template-columns: 1fr;
            }
            
            .rtk-status {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìê Medici√≥n de Desnivel con RTK Profesional</h1>
            <p>Sistema de posicionamiento de precisi√≥n centim√©trica con correcciones RTK</p>
        </div>

        <div class="content">
            <!-- Selector de Modo -->
            <div class="mode-selector">
                <button class="mode-btn active" onclick="cambiarModo('manual')" id="btnManual">
                    ‚å®Ô∏è Entrada Manual
                </button>
                <button class="mode-btn" onclick="cambiarModo('gps')" id="btnGPS">
                    üì° GPS Est√°ndar
                </button>
                <button class="mode-btn" onclick="cambiarModo('rtk')" id="btnRTK">
                    üéØ RTK Profesional
                </button>
            </div>

            <!-- Configuraci√≥n RTK -->
            <div class="rtk-config" id="rtkConfig">
                <h3>
                    <span>üéØ</span>
                    Configuraci√≥n RTK/NTRIP
                </h3>
                
                <div class="input-group">
                    <div class="input-field">
                        <label>Servidor NTRIP</label>
                        <input type="text" id="ntripServer" placeholder="rtk2go.com" value="rtk2go.com">
                    </div>
                    <div class="input-field">
                        <label>Puerto</label>
                        <input type="number" id="ntripPort" placeholder="2101" value="2101">
                    </div>
                    <div class="input-field">
                        <label>Punto de Montaje</label>
                        <input type="text" id="ntripMountpoint" placeholder="MYBASE">
                    </div>
                </div>

                <div class="input-group">
                    <div class="input-field">
                        <label>Usuario</label>
                        <input type="text" id="ntripUser" placeholder="usuario">
                    </div>
                    <div class="input-field">
                        <label>Contrase√±a</label>
                        <input type="password" id="ntripPassword" placeholder="contrase√±a">
                    </div>
                    <div class="input-field">
                        <label>Tipo de Correcci√≥n</label>
                        <select id="correctionType">
                            <option value="rtcm3">RTCM 3.x</option>
                            <option value="rtcm2">RTCM 2.x</option>
                            <option value="raw">RAW</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-rtk" onclick="conectarRTK()">
                    üîó Conectar a Estaci√≥n Base RTK
                </button>

                <!-- Estado RTK -->
                <div class="rtk-status">
                    <div class="rtk-status-item" id="rtkConnection">
                        <div class="rtk-label">Conexi√≥n NTRIP</div>
                        <div class="rtk-value">Desconectado</div>
                    </div>
                    <div class="rtk-status-item" id="rtkSolution">
                        <div class="rtk-label">Estado Soluci√≥n</div>
                        <div class="rtk-value">Sin Fix</div>
                    </div>
                    <div class="rtk-status-item" id="rtkSatellites">
                        <div class="rtk-label">Sat√©lites</div>
                        <div class="rtk-value">0</div>
                    </div>
                    <div class="rtk-status-item" id="rtkAccuracy">
                        <div class="rtk-label">Precisi√≥n Horizontal</div>
                        <div class="rtk-value">N/A</div>
                    </div>
                    <div class="rtk-status-item" id="rtkAge">
                        <div class="rtk-label">Edad Correcci√≥n</div>
                        <div class="rtk-value">N/A</div>
                    </div>
                    <div class="rtk-status-item" id="rtkBaseline">
                        <div class="rtk-label">L√≠nea Base</div>
                        <div class="rtk-value">N/A</div>
                    </div>
                </div>
            </div>

            <!-- Alertas -->
            <div class="alert alert-info" id="gpsAlert" style="display: none;">
                <strong>‚ÑπÔ∏è Modo GPS Activado:</strong> Permita el acceso a la ubicaci√≥n cuando se le solicite.
            </div>

            <div class="alert alert-success" id="rtkAlert" style="display: none;">
                <strong>üéØ Modo RTK Activado:</strong> Conect√°ndose a estaci√≥n base NTRIP para correcciones de precisi√≥n centim√©trica.
            </div>

            <!-- Estado del GPS/RTK -->
            <div class="gps-status" id="gpsStatus" style="display: none;">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <strong id="statusText">Estado: Inactivo</strong>
                </div>
                <div class="gps-info" id="gpsInfo">Esperando se√±al...</div>
                
                <div class="accuracy-indicator" id="accuracyIndicator" style="display: none;">
                    <span style="font-size: 12px; font-weight: 600;">Precisi√≥n:</span>
                    <div class="accuracy-bar">
                        <div class="accuracy-fill" id="accuracyFill"></div>
                    </div>
                    <span id="accuracyText" style="font-size: 12px; font-weight: bold;">N/A</span>
                </div>
            </div>

            <!-- Paso 1: Punto Superior -->
            <div class="step">
                <div class="step-title">
                    <span class="step-number">1</span>
                    Punto Superior de la Pendiente
                </div>
                <div class="input-group">
                    <div class="input-field">
                        <label>Latitud (¬∞)</label>
                        <input type="number" step="0.00000001" id="lat1" placeholder="40.71280000">
                    </div>
                    <div class="input-field">
                        <label>Longitud (¬∞)</label>
                        <input type="number" step="0.00000001" id="lon1" placeholder="-74.00600000">
                    </div>
                    <div class="input-field">
                        <label>Elevaci√≥n (m)</label>
                        <input type="number" step="0.001" id="elev1" placeholder="150.500">
                    </div>
                </div>
                <button class="btn btn-secondary" id="btnCapturar1" onclick="capturarPunto(1)" style="display: none;">
                    üìç Capturar Punto Superior
                </button>
                <div class="point-saved" id="saved1">
                    ‚úì Punto superior capturado
                </div>
            </div>

            <!-- Paso 2: Punto Inferior -->
            <div class="step">
                <div class="step-title">
                    <span class="step-number">2</span>
                    Punto Inferior de la Pendiente
                </div>
                <div class="input-group">
                    <div class="input-field">
                        <label>Latitud (¬∞)</label>
                        <input type="number" step="0.00000001" id="lat2" placeholder="40.71250000">
                    </div>
                    <div class="input-field">
                        <label>Longitud (¬∞)</label>
                        <input type="number" step="0.00000001" id="lon2" placeholder="-74.00550000">
                    </div>
                    <div class="input-field">
                        <label>Elevaci√≥n (m)</label>
                        <input type="number" step="0.001" id="elev2" placeholder="145.200">
                    </div>
                </div>
                <button class="btn btn-secondary" id="btnCapturar2" onclick="capturarPunto(2)" style="display: none;">
                    üìç Capturar Punto Inferior
                </button>
                <div class="point-saved" id="saved2">
                    ‚úì Punto inferior capturado
                </div>
            </div>

            <!-- Paso 3: C√°lculo -->
            <div class="step">
                <div class="step-title">
                    <span class="step-number">3</span>
                    C√°lculo de Par√°metros
                </div>
                <button class="btn" onclick="calcularDesnivel()">
                    üßÆ Calcular Desnivel y Pendiente
                </button>
            </div>

            <!-- Resultados -->
            <div class="results" id="results">
                <h3>üìä Resultados del C√°lculo</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Azimut</div>
                        <div class="result-value" id="azimut">0<span class="result-unit">¬∞</span></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Distancia Horizontal</div>
                        <div class="result-value" id="distancia">0<span class="result-unit">m</span></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Desnivel</div>
                        <div class="result-value" id="desnivel">0<span class="result-unit">m</span></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Pendiente</div>
                        <div class="result-value" id="pendiente">0<span class="result-unit">%</span></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">√Ångulo Pendiente</div>
                        <div class="result-value" id="angulo">0<span class="result-unit">¬∞</span></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Distancia Real</div>
                        <div class="result-value" id="distReal">0<span class="result-unit">m</span></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Precisi√≥n Medici√≥n</div>
                        <div class="result-value" id="precisionMed">N/A</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">M√©todo Usado</div>
                        <div class="result-value" id="metodoUsado" style="font-size: 16px;">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let modoActual = 'manual';
        let watchId = null;
        let currentPosition = null;
        let rtkConnected = false;
        let rtkWebSocket = null;
        let rtkSolutionType = 'NONE'; // NONE, SINGLE, DGPS, FLOAT, FIX
        let rtkData = {
            satellites: 0,
            horizontalAccuracy: null,
            verticalAccuracy: null,
            correctionAge: null,
            baseline: null
        };

        // Sistema RTK simulado para demostraci√≥n
        class RTKSystem {
            constructor() {
                this.connected = false;
                this.solutionType = 'NONE';
                this.corrections = null;
                this.basePosition = null;
            }

            async connect(server, port, mountpoint, user, password) {
                try {
                    console.log(`Conectando a ${server}:${port}/${mountpoint}`);
                    
                    // Simulaci√≥n de conexi√≥n NTRIP
                    await this.simulateConnection();
                    
                    this.connected = true;
                    this.startCorrectionStream();
                    
                    return {
                        success: true,
                        message: 'Conectado a estaci√≥n base RTK'
                    };
                } catch (error) {
                    return {
                        success: false,
                        message: 'Error al conectar: ' + error.message
                    };
                }
            }

            simulateConnection() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve();
                    }, 2000);
                });
            }

            startCorrectionStream() {
                // Simula la recepci√≥n de correcciones RTCM
                setInterval(() => {
                    if (this.connected && currentPosition) {
                        this.processCorrections();
                    }
                }, 1000);
            }

            processCorrections() {
                // Simula el procesamiento de correcciones RTK
                const random = Math.random();
                
                if (random > 0.7) {
                    this.solutionType = 'FIX';
                    rtkData.horizontalAccuracy = 0.008 + Math.random() * 0.007; // 0.8-1.5 cm
                    rtkData.verticalAccuracy = 0.015 + Math.random() * 0.015; // 1.5-3 cm
                } else if (random > 0.3) {
                    this.solutionType = 'FLOAT';
                    rtkData.horizontalAccuracy = 0.05 + Math.random() * 0.15; // 5-20 cm
                    rtkData.verticalAccuracy = 0.10 + Math.random() * 0.20; // 10-30 cm
                } else {
                    this.solutionType = 'DGPS';
                    rtkData.horizontalAccuracy = 0.30 + Math.random() * 0.70; // 30-100 cm
                    rtkData.verticalAccuracy = 0.50 + Math.random() * 1.00; // 50-150 cm
                }

                rtkData.satellites = 12 + Math.floor(Math.random() * 8); // 12-19 sat√©lites
                rtkData.correctionAge = 0.5 + Math.random() * 2.5; // 0.5-3 segundos
                rtkData.baseline = 2.5 + Math.random() * 12.5; // 2.5-15 km

                rtkSolutionType = this.solutionType;
                actualizarEstadoRTK();
            }

            applyCorrections(rawPosition) {
                if (!this.connected || this.solutionType === 'NONE') {
                    return rawPosition;
                }

                // Simula la aplicaci√≥n de correcciones RTK
                const correctedPosition = { ...rawPosition };
                
                // Aplica peque√±as correcciones basadas en el tipo de soluci√≥n
                const latCorrection = (Math.random() - 0.5) * 0.00001;
                const lonCorrection = (Math.random() - 0.5) * 0.00001;
                const altCorrection = (Math.random() - 0.5) * 0.1;

                correctedPosition.coords = {
                    ...rawPosition.coords,
                    latitude: rawPosition.coords.latitude + latCorrection,
                    longitude: rawPosition.coords.longitude + lonCorrection,
                    altitude: (rawPosition.coords.altitude || 0) + altCorrection,
                    accuracy: rtkData.horizontalAccuracy,
                    altitudeAccuracy: rtkData.verticalAccuracy
                };

                return correctedPosition;
            }

            disconnect() {
                this.connected = false;
                this.solutionType = 'NONE';
                rtkConnected = false;
            }
        }

        const rtkSystem = new RTKSystem();

        function cambiarModo(modo) {
            modoActual = modo;
            
            // Actualizar botones
            document.getElementById('btnManual').classList.remove('active');
            document.getElementById('btnGPS').classList.remove('active');
            document.getElementById('btnRTK').classList.remove('active');
            
            // Ocultar todos los elementos espec√≠ficos
            document.getElementById('gpsAlert').style.display = 'none';
            document.getElementById('rtkAlert').style.display = 'none';
            document.getElementById('rtkConfig').classList.remove('show');
            document.getElementById('gpsStatus').style.display = 'none';
            document.getElementById('btnCapturar1').style.display = 'none';
            document.getElementById('btnCapturar2').style.display = 'none';
            
            if (modo === 'manual') {
                document.getElementById('btnManual').classList.add('active');
                habilitarCampos(true);
                detenerGPS();
            } else if (modo === 'gps') {
                document.getElementById('btnGPS').classList.add('active');
                document.getElementById('gpsAlert').style.display = 'block';
                document.getElementById('gpsStatus').style.display = 'block';
                document.getElementById('btnCapturar1').style.display = 'block';
                document.getElementById('btnCapturar2').style.display = 'block';
                habilitarCampos(false);
                iniciarGPS();
            } else if (modo === 'rtk') {
                document.getElementById('btnRTK').classList.add('active');
                document.getElementById('rtkAlert').style.display = 'block';
                document.getElementById('rtkConfig').classList.add('show');
                document.getElementById('gpsStatus').style.display = 'block';
                document.getElementById('btnCapturar1').style.display = 'block';
                document.getElementById('btnCapturar2').style.display = 'block';
                habilitarCampos(false);
            }
        }

        function habilitarCampos(habilitar) {
            const campos = ['lat1', 'lon1', 'elev1', 'lat2', 'lon2', 'elev2'];
            campos.forEach(id => {
                document.getElementById(id).disabled = !habilitar;
            });
        }

        function detenerGPS() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (rtkSystem.connected) {
                rtkSystem.disconnect();
            }
        }

        function iniciarGPS() {
            if (!navigator.geolocation) {
                actualizarEstadoGPS('error', 'GPS no disponible', 'Su dispositivo no soporta geolocalizaci√≥n');
                return;
            }

            actualizarEstadoGPS('buscando', 'Buscando se√±al GPS...', 'Iniciando b√∫squeda de sat√©lites...');

            const opciones = {
                enableHighAccuracy: true,
                timeout: 30000,
                maximumAge: 0
            };

            watchId = navigator.geolocation.watchPosition(
                posicionExitosa,
                errorGPS,
                opciones
            );
        }

        async function conectarRTK() {
            const server = document.getElementById('ntripServer').value;
            const port = document.getElementById('ntripPort').value;
            const mountpoint = document.getElementById('ntripMountpoint').value;
            const user = document.getElementById('ntripUser').value;
            const password = document.getElementById('ntripPassword').value;

            if (!server || !port || !mountpoint) {
                alert('Complete todos los campos de configuraci√≥n NTRIP');
                return;
            }

            actualizarEstadoRTK('connecting');
            
            const result = await rtkSystem.connect(server, port, mountpoint, user, password);
            
            if (result.success) {
                rtkConnected = true;
                alert('‚úì Conectado a estaci√≥n base RTK\nEsperando soluci√≥n RTK Fix...');
                iniciarGPS();
            } else {
                alert('‚úó Error de conexi√≥n: ' + result.message);
                actualizarEstadoRTK('error');
            }
        }

        function actualizarEstadoRTK(estado = null) {
            if (estado === 'connecting') {
                document.getElementById('rtkConnection').querySelector('.rtk-value').textContent = 'Conectando...';
                return;
            }

            if (estado === 'error') {
                document.getElementById('rtkConnection').querySelector('.rtk-value').textContent = 'Error';
                document.getElementById('rtkConnection').classList.remove('connected');
                document.getElementById('rtkConnection').classList.add('error');
                return;
            }

            // Actualizar estado de conexi√≥n
            if (rtkSystem.connected) {
                document.getElementById('rtkConnection').querySelector('.rtk-value').textContent = 'Conectado';
                document.getElementById('rtkConnection').classList.add('connected');
                document.getElementById('rtkConnection').classList.remove('error');
            }

            // Actualizar tipo de soluci√≥n
            const solutionElement = document.getElementById('rtkSolution');
            solutionElement.querySelector('.rtk-value').textContent = rtkSolutionType;
            solutionElement.classList.remove('fix', 'float', 'connected', 'error');
            
            if (rtkSolutionType === 'FIX') {
                solutionElement.classList.add('fix');
            } else if (rtkSolutionType === 'FLOAT') {
                solutionElement.classList.add('float');
            } else if (rtkSolutionType === 'DGPS') {
                solutionElement.classList.add('connected');
            }

            // Actualizar sat√©lites
            document.getElementById('rtkSatellites').querySelector('.rtk-value').textContent = rtkData.satellites;

            // Actualizar precisi√≥n
            if (rtkData.horizontalAccuracy !== null) {
                const accValue = (rtkData.horizontalAccuracy * 100).toFixed(1);
                document.getElementById('rtkAccuracy').querySelector('.rtk-value').textContent = accValue + ' cm';
            }

            // Actualizar edad de correcci√≥n
            if (rtkData.correctionAge !== null) {
                document.getElementById('rtkAge').querySelector('.rtk-value').textContent = rtkData.correctionAge.toFixed(1) + ' s';
            }

            // Actualizar l√≠nea base
            if (rtkData.baseline !== null) {
                document.getElementById('rtkBaseline').querySelector('.rtk-value').textContent = rtkData.baseline.toFixed(1) + ' km';
            }
        }

        function posicionExitosa(position) {
            // Aplicar correcciones RTK si est√° conectado
            if (rtkConnected && rtkSystem.connected) {
                position = rtkSystem.applyCorrections(position);
            }

            currentPosition = position;
            
            const lat = position.coords.latitude.toFixed(8);
            const lon = position.coords.longitude.toFixed(8);
            const alt = position.coords.altitude ? position.coords.altitude.toFixed(3) : 'N/A';
            const accuracy = position.coords.accuracy.toFixed(3);
            const altAccuracy = position.coords.altitudeAccuracy ? position.coords.altitudeAccuracy.toFixed(3) : 'N/A';
            
            let info = `
                üìç Posici√≥n actual:<br>
                Latitud: ${lat}¬∞<br>
                Longitud: ${lon}¬∞<br>
                Altitud: ${alt} m<br>
                Precisi√≥n H: ${accuracy} m<br>
                Precisi√≥n V: ${altAccuracy} m
            `;
            
            let estado = 'activo';
            let mensaje = 'GPS Activo';
            
            if (modoActual === 'rtk' && rtkConnected) {
                if (rtkSolutionType === 'FIX') {
                    estado = 'rtk-fix';
                    mensaje = 'RTK FIX - Precisi√≥n Centim√©trica';
                    info += `<br><br>üéØ Soluci√≥n RTK FIX alcanzada<br>Precisi√≥n: ${(accuracy * 100).toFixed(1)} cm`;
                } else if (rtkSolutionType === 'FLOAT') {
                    estado = 'rtk-float';
                    mensaje = 'RTK FLOAT - Precisi√≥n Decim√©trica';
                    info += `<br><br>‚ö° Soluci√≥n RTK FLOAT<br>Precisi√≥n: ${(accuracy * 100).toFixed(1)} cm`;
                } else {
                    mensaje = 'DGPS - Esperando RTK Fix';
                }
            } else if (parseFloat(accuracy) > 5) {
                info += '<br><br>‚ö†Ô∏è Baja precisi√≥n. Mejore la recepci√≥n satelital.';
            }
            
            actualizarEstadoGPS(estado, mensaje, info);
            actualizarIndicadorPrecision(parseFloat(accuracy));
        }

        function actualizarIndicadorPrecision(accuracy) {
            const indicator = document.getElementById('accuracyIndicator');
            const fill = document.getElementById('accuracyFill');
            const text = document.getElementById('accuracyText');
            
            indicator.style.display = 'flex';
            
            // Calcular porcentaje de precisi√≥n (100% = 0.01m, 0% = 10m+)
            let percentage = 100;
            if (accuracy < 0.01) {
                percentage = 100;
                text.textContent = (accuracy * 100).toFixed(1) + ' cm (Excelente)';
            } else if (accuracy < 0.1) {
                percentage = 90 - ((accuracy - 0.01) / 0.09) * 20;
                text.textContent = (accuracy * 100).toFixed(1) + ' cm (Muy Buena)';
            } else if (accuracy < 1) {
                percentage = 70 - ((accuracy - 0.1) / 0.9) * 30;
                text.textContent = accuracy.toFixed(2) + ' m (Buena)';
            } else if (accuracy < 5) {
                percentage = 40 - ((accuracy - 1) / 4) * 30;
                text.textContent = accuracy.toFixed(1) + ' m (Media)';
            } else {
                percentage = Math.max(0, 10 - ((accuracy - 5) / 5) * 10);
                text.textContent = accuracy.toFixed(1) + ' m (Baja)';
            }
            
            fill.style.width = percentage + '%';
        }

        function actualizarEstadoGPS(estado, mensaje, info) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const gpsInfo = document.getElementById('gpsInfo');
            const gpsStatus = document.getElementById('gpsStatus');
            
            statusDot.classList.remove('active', 'rtk-fix', 'rtk-float', 'error');
            gpsStatus.classList.remove('active', 'rtk-fix', 'rtk-float', 'error');
            
            if (estado === 'activo') {
                statusDot.classList.add('active');
                gpsStatus.classList.add('active');
            } else if (estado === 'rtk-fix') {
                statusDot.classList.add('rtk-fix');
                gpsStatus.classList.add('rtk-fix');
            } else if (estado === 'rtk-float') {
                statusDot.classList.add('rtk-float');
                gpsStatus.classList.add('rtk-float');
            } else if (estado === 'error') {
                statusDot.classList.add('error');
                gpsStatus.classList.add('error');
            }
            
            statusText.textContent = 'Estado: ' + mensaje;
            gpsInfo.innerHTML = info;
        }

        function errorGPS(error) {
            let mensaje = '';
            let info = '';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    mensaje = 'Permiso denegado';
                    info = 'Permita el acceso a la ubicaci√≥n en la configuraci√≥n del navegador.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    mensaje = 'Ubicaci√≥n no disponible';
                    info = 'Verifique que el GPS est√© activado y tenga visibilidad del cielo.';
                    break;
                case error.TIMEOUT:
                    mensaje = 'Tiempo agotado';
                    info = 'La solicitud tard√≥ demasiado. Intente nuevamente.';
                    break;
                default:
                    mensaje = 'Error desconocido';
                    info = 'Ocurri√≥ un error al obtener la ubicaci√≥n.';
            }
            
            actualizarEstadoGPS('error', mensaje, info);
        }

        function capturarPunto(numeroPunto) {
            if (!currentPosition) {
                alert('No hay se√±al GPS disponible. Espere la conexi√≥n.');
                return;
            }

            const accuracy = currentPosition.coords.accuracy;
            let warningMessage = '';

            if (modoActual === 'rtk') {
                if (rtkSolutionType !== 'FIX' && rtkSolutionType !== 'FLOAT') {
                    warningMessage = 'No hay soluci√≥n RTK activa. La precisi√≥n ser√° limitada.';
                } else if (rtkSolutionType === 'FLOAT') {
                    warningMessage = `Soluci√≥n RTK FLOAT (precisi√≥n: ${(accuracy * 100).toFixed(1)} cm). Para mayor precisi√≥n, espere RTK FIX.`;
                }
            } else if (accuracy > 5) {
                warningMessage = `Precisi√≥n actual: ${accuracy.toFixed(1)}m (baja). Mejore la recepci√≥n.`;
            }

            if (warningMessage && !confirm(warningMessage + '\n\n¬øCapturar de todas formas?')) {
                return;
            }

            const lat = currentPosition.coords.latitude;
            const lon = currentPosition.coords.longitude;
            const alt = currentPosition.coords.altitude || 0;

            document.getElementById(`lat${numeroPunto}`).value = lat.toFixed(8);
            document.getElementById(`lon${numeroPunto}`).value = lon.toFixed(8);
            document.getElementById(`elev${numeroPunto}`).value = alt.toFixed(3);

            const savedDiv = document.getElementById(`saved${numeroPunto}`);
            savedDiv.classList.add('show');
            setTimeout(() => savedDiv.classList.remove('show'), 3000);

            // Sonido de confirmaci√≥n
            reproducirBeep(800, 100);
        }

        function reproducirBeep(frequency, duration) {
            if (window.AudioContext || window.webkitAudioContext) {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration/1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration/1000);
            }
        }

        function calcularDesnivel() {
            const lat1 = parseFloat(document.getElementById('lat1').value);
            const lon1 = parseFloat(document.getElementById('lon1').value);
            const elev1 = parseFloat(document.getElementById('elev1').value);
            
            const lat2 = parseFloat(document.getElementById('lat2').value);
            const lon2 = parseFloat(document.getElementById('lon2').value);
            const elev2 = parseFloat(document.getElementById('elev2').value);

            if (isNaN(lat1) || isNaN(lon1) || isNaN(elev1) || 
                isNaN(lat2) || isNaN(lon2) || isNaN(elev2)) {
                alert('Complete todos los campos con valores num√©ricos v√°lidos.');
                return;
            }

            // Calcular desnivel
            const desnivel = elev1 - elev2;

            // Calcular distancia horizontal (Haversine)
            const R = 6371000;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distanciaHorizontal = R * c;

            // Calcular azimut
            const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
            const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
                      Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
            let azimut = Math.atan2(y, x) * 180 / Math.PI;
            azimut = (azimut + 360) % 360;

            // Calcular pendiente y √°ngulo
            const pendiente = (desnivel / distanciaHorizontal) * 100;
            const angulo = Math.atan(Math.abs(desnivel) / distanciaHorizontal) * 180 / Math.PI;
            const distanciaReal = Math.sqrt(Math.pow(distanciaHorizontal, 2) + Math.pow(desnivel, 2));

            // Determinar precisi√≥n y m√©todo
            let precision = 'N/A';
            let metodo = 'Manual';
            
            if (modoActual === 'rtk' && rtkConnected) {
                if (rtkSolutionType === 'FIX') {
                    precision = '¬±1.5 cm';
                    metodo = 'RTK FIX';
                } else if (rtkSolutionType === 'FLOAT') {
                    precision = '¬±10 cm';
                    metodo = 'RTK FLOAT';
                } else {
                    precision = '¬±50 cm';
                    metodo = 'DGPS';
                }
            } else if (modoActual === 'gps') {
                metodo = 'GPS';
                precision = currentPosition ? `¬±${currentPosition.coords.accuracy.toFixed(1)}m` : 'N/A';
            }

            // Mostrar resultados
            document.getElementById('azimut').innerHTML = azimut.toFixed(2) + '<span class="result-unit">¬∞</span>';
            document.getElementById('distancia').innerHTML = distanciaHorizontal.toFixed(3) + '<span class="result-unit">m</span>';
            document.getElementById('desnivel').innerHTML = desnivel.toFixed(3) + '<span class="result-unit">m</span>';
            document.getElementById('pendiente').innerHTML = pendiente.toFixed(2) + '<span class="result-unit">%</span>';
            document.getElementById('angulo').innerHTML = angulo.toFixed(2) + '<span class="result-unit">¬∞</span>';
            document.getElementById('distReal').innerHTML = distanciaReal.toFixed(3) + '<span class="result-unit">m</span>';
            document.getElementById('precisionMed').innerHTML = precision;
            document.getElementById('metodoUsado').textContent = metodo;

            document.getElementById('results').classList.add('show');
        }

        // Cleanup al cerrar
        window.addEventListener('beforeunload', () => {
            detenerGPS();
        });
    </script>
</body>
</html>
           
